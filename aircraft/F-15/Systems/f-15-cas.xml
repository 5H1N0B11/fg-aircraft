<?xml version="1.0"?>

<!-- McDonnell Douglas F-15 Control Augmentation System -->
<!-- (c) 2019 Joshua Davidson (Octal450) -->

<system name="F-15: CAS">
	
	<property value="0">cas/yaw/ari-input</property>
	<property value="0">cas/yaw/beta-pd</property>
	<property value="0">cas/yaw/beta-p-gain</property>
	<property value="0">cas/yaw/beta-d-gain</property>
	
	<channel name="Libraries">
		
		<switch name="cas/roll/cas-active">
			<default value="0"/>
			<test logic="AND" value="1">
				fcs/roll-damper-enable ne 0
				position/aircraft-on-ground eq 0
				systems/hydraulics/flight-system-pressure eq 1
				autoflight/output/roll-master ne 1
			</test>
		</switch>
		
		<switch name="cas/pitch/cas-active">
			<default value="0"/>
			<test logic="AND" value="1">
				fcs/pitch-damper-enable ne 0
				position/aircraft-on-ground eq 0
				systems/hydraulics/flight-system-pressure eq 1
				autoflight/output/pitch-master ne 1
			</test>
		</switch>
		
		<switch name="cas/yaw/cas-active">
			<default value="0"/>
			<test logic="AND" value="1">
				fcs/yaw-damper-enable ne 0
				position/aircraft-on-ground eq 0
				systems/hydraulics/flight-system-pressure eq 1
			</test>
		</switch>
		
		<fcs_function name="cas/yaw/beta-p-gain">
			<function>
				<table>
					<independentVar lookup="row">velocities/mach</independentVar>
					<tableData>
						0.3  3.0
						0.7  1.1
						1.1  0.0
					</tableData>
				</table>
			</function>
		</fcs_function>
		
		<fcs_function name="cas/yaw/beta-d-gain">
			<function>
				<table>
					<independentVar lookup="row">velocities/mach</independentVar>
					<tableData>
						0.3  5.0
						0.7  2.9
						1.1  0.0
					</tableData>
				</table>
			</function>
		</fcs_function>
	
	</channel>
	
	<channel name="Roll Axis">
		
		<fcs_function name="cas/roll/rate-demand"> <!-- TM-72861 - Figure 21 -->
			<function>
				<sum>
					<table>
						<independentVar lookup="row">/controls/flight/aileron</independentVar>
						<tableData>
							-1.00 -213.1
							-0.01    0.0
							 0.00    0.0
							 0.01    0.0
							 1.00  213.1
						</tableData>
					</table>
					<table>
						<independentVar lookup="row">/controls/flight/aileron-trim</independentVar>
						<tableData>
							-1.00 -24.5
							-0.01   0.0
							 0.00   0.0
							 0.01   0.0
							 1.00  24.5
						</tableData>
					</table>
				</sum>
			</function>
		</fcs_function>
		
		<lag_filter name="cas/roll/rate-lag">
			<input>cas/roll/rate-demand</input>
			<c1>165.6</c1>
		</lag_filter>
		
		<summer name="cas/roll/rate-error">
			<input>/orientation/roll-rate-degps</input>
			<input>-cas/roll/rate-lag</input>
		</summer>
		
		<scheduled_gain name="cas/roll/rate-p">
			<input>cas/roll/rate-error</input>
			<table>
				<independentVar lookup="row">velocities/vc-kts</independentVar>
				<tableData>
					150 -0.018
					950 -0.011
				</tableData>
			</table>
		</scheduled_gain>
		
		<switch name="cas/roll-output">
			<default value="0"/>
			<test value="cas/roll/rate-p">
				cas/roll/cas-active eq 1
			</test>
		</switch>
	
	</channel>
	
	<channel name="Pitch Axis">
		
		<washout_filter name="cas/pitch/q-washout">
			<input>velocities/q-rad_sec</input>
			<c1>1.0</c1>
		</washout_filter>
		
		<scheduled_gain name="cas/pitch/q-damper">
			<input>cas/pitch/q-washout</input>
			<table>
				<independentVar lookup="row">velocities/vc-kts</independentVar>
				<tableData>
					150  1.5
					950  0.5
				</tableData>
			</table>
			<clipto>
				<min>-0.2857142857142857</min>
				<max>0.2857142857142857</max>
			</clipto>
		</scheduled_gain>
		
		<washout_filter name="cas/pitch/g-washout">
			<input>/accelerations/pilot-gdamped</input> <!-- Same prop as G Meter in Cockpit -->
			<c1>3.5</c1>
		</washout_filter>
		
		<scheduled_gain name="cas/pitch/g-damper">
			<input>cas/pitch/g-washout</input>
			<table>
				<independentVar lookup="row">velocities/vc-kts</independentVar>
				<tableData>
					150  0.05
					950  0.01
				</tableData>
			</table>
			<clipto>
				<min>-0.2857142857142857</min>
				<max>0.2857142857142857</max>
			</clipto>
		</scheduled_gain>
		
		<fcs_function name="cas/pitch/g-demand">
			<description>
				G Table from TM-72861 - Figure 18
				You may notice that there are 3 possible modes of operation: Manual Mode, CSS Mode, and A/P Pitch On Mode.
				In Manual Mode, we use the elevator with no deadzone. We only have the CSS breakout deadzone.
				In CSS Mode, we use the Stick Steering (SS) elevator from the autopilot, and the breakout from the CSS.
				This is because the autopilot has an adjustable deadzone, which when out of, engages the CSS A/P function.
				Lastly in A/P Pitch On Mode, we just keep it at 1G.
				This prevents the Lead-Lag Compensator from doing bad behavior in all three modes.
				
				TODO: Add Trim Bias?
			</description>
			<function>
				<ifthen>
					<nq>
						<property>autoflight/output/pitch-master</property>
						<value>1</value>
					</nq>
					<ifthen>
						<nq>
							<property>autoflight/input/pitch-switch</property>
							<value>1</value>
						</nq>
						<table> <!-- Manual Mode -->
							<independentVar lookup="row">/controls/flight/elevator</independentVar>
							<tableData>
								-1.00  8.0
								-0.54  3.6
								-0.01  1.0
								 0.00  1.0
								 0.01  1.0
								 0.70 -1.6
								 1.00 -4.0
							</tableData>
						</table>
						<table> <!-- CSS Mode -->
							<independentVar lookup="row">autoflight/ss/elevator-norm</independentVar>
							<tableData>
								-1.00  8.0
								-0.54  3.6
								-0.01  1.0
								 0.00  1.0
								 0.01  1.0
								 0.70 -1.6
								 1.00 -4.0
							</tableData>
						</table>
					</ifthen>
					<value>1.0</value> <!-- A/P Pitch On Mode -->
				</ifthen>
			</function>
		</fcs_function>
		
		<lead_lag_filter name="cas/pitch/g-leadlag">
			<description>
				This changes the profile of the G demand going into the system in order to improve behavior of the aircraft.
				It will smoothly acheive the demanded G assuming the trim is correct. (there is no integrator)
				The numbers are carefully designed for a specific behavior, so please do not change them.
				It also is designed to work with the q damper and PRC.
			</description>
			<input>cas/pitch/g-demand</input>
			<c1>-1.2</c1> <!-- Yes, this should be negative -->
			<c2>1.0</c2>
			<c3>0.5</c3>
			<c4>1.0</c4>
		</lead_lag_filter>
		
		<summer name="cas/pitch/g-error">
			<input>/accelerations/pilot-gdamped</input> <!-- Same prop as G Meter in Cockpit -->
			<input>-cas/pitch/g-leadlag</input>
		</summer>
		
		<scheduled_gain name="cas/pitch/g-feel">
			<input>cas/pitch/g-error</input>
			<table>
				<independentVar lookup="row">velocities/vc-kts</independentVar>
				<tableData>
					150  0.05
					950  0.01
				</tableData>
			</table>
			<clipto>
				<min>-0.3448275862068966</min>
				<max>0.3448275862068966</max>
			</clipto>
		</scheduled_gain>
		
		<summer name="cas/pitch/output-sum">
			<input>cas/pitch/q-damper</input>
			<input>cas/pitch/g-damper</input>
			<input>cas/pitch/g-feel</input>
			<clipto> <!-- +-10 degrees -->
				<min>-0.3448275862068966</min>
				<max>0.3448275862068966</max>
			</clipto>
		</summer>
		
		<switch name="cas/pitch-output">
			<default value="0"/>
			<test value="cas/pitch/output-sum">
				cas/pitch/cas-active eq 1
			</test>
		</switch>
	
	</channel>
	
	<channel name="Yaw Axis">
		
		<washout_filter name="cas/yaw/r-washout">
			<input>velocities/r-rad_sec</input>
			<c1>0.5</c1>
		</washout_filter>
		
		<scheduled_gain name="cas/yaw/rate-damper">
			<input>cas/yaw/r-washout</input>
			<table>
				<independentVar lookup="row">velocities/vc-kts</independentVar>
				<tableData>
					150 -3.2
					950 -0.5
				</tableData>
			</table>
			<clipto>
				<min>-0.3</min>
				<max>0.3</max>
			</clipto>
		</scheduled_gain>
		
		<scheduled_gain name="cas/yaw/accel-damper">
			<input>accelerations/Ny</input>
			<table>
				<independentVar lookup="row">velocities/vc-kts</independentVar>
				<tableData>
					150  0.05
					950  0.01
				</tableData>
			</table>
			<clipto>
				<min>-0.3</min>
				<max>0.3</max>
			</clipto>
		</scheduled_gain>
		
		<summer name="cas/yaw/damper">
			<input>cas/yaw/rate-damper</input>
			<input>cas/yaw/accel-damper</input>
			<clipto>
				<min>-0.3</min>
				<max>0.3</max>
			</clipto>
		</summer>
		
		<switch name="cas/yaw/beta">
			<default value="0"/>
			<test logic="AND" value="aero/beta-rad">
				cas/yaw/ari-input le 0.02
				cas/yaw/ari-input ge -0.02
				/controls/flight/rudder le 0.02
				/controls/flight/rudder ge -0.02
				cas/yaw/cas-active eq 1
			</test>
		</switch>
		
		<pid name="cas/yaw/beta-pd-v"> <!-- Only P and D are used -->
			<input>cas/yaw/beta</input>
			<kp>cas/yaw/beta-p-gain</kp>
			<ki>0.0</ki>
			<kd>cas/yaw/beta-d-gain</kd>
			<output>cas/yaw/beta-pd</output>
			<clipto>
				<min>-0.3</min>
				<max>0.3</max>
			</clipto>
		</pid>
		
		<scheduled_gain name="cas/yaw/ari">
			<input>velocities/p-rad_sec</input>
			<table>
				<independentVar lookup="row">velocities/vc-kts</independentVar>
				<tableData>
					150  0.10
					950  0.02
				</tableData>
			</table>
			<clipto>
				<min>-0.3</min>
				<max>0.3</max>
			</clipto>
		</scheduled_gain>
		
		<summer name="cas/yaw/cmd">
			<input>cas/yaw/damper</input>
			<input>cas/yaw/beta-pd</input>
			<input>cas/yaw/ari</input>
			<clipto>
				<min>-0.3</min>
				<max>0.3</max>
			</clipto>
		</summer>
		
		<switch name="cas/yaw-output">
			<default value="0"/>
			<test value="cas/yaw/cmd">
				cas/yaw/cas-active eq 1
			</test>
		</switch>
	
	</channel>

</system>
