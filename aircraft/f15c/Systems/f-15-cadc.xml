<?xml version="1.0"?>
<!--
        Description: F14 CADC (AFCS, MANEUVERING FLAPS/SLATS)  
        Author: Richard Harrison (rjh@zaretto.com)
        References: F14-AAD-1, NASA TT F15,406 Improvement of manuevrability at low speed, W. Staudacher, 1972
-->


<system name="CADC">

    <property value="1e-005"> systems/afcs/altitude-hold-pid-kp </property>
    <property value="1e-006"> systems/afcs/altitude-hold-pid-ki </property>
    <property value="0.0005"> systems/afcs/altitude-hold-pid-kd </property>
    <property value="1.2"> systems/afcs/altitude-hold-elevator-gain </property>

    <property value="2"> systems/afcs/altitude-hold-lag-constant </property>
    <property value="0">systems/afcs/target-altitude-ft</property>
    <property value="0">systems/afcs/altitude-hold-active</property>
    <property value="0">systems/cadc/manuv-slat-extension-manual</property>
    <property value="0.9">systems/cadc/manuv-flap-extension-calc-lag</property>
    <property value="1.3">systems/cadc/manuv-flap-extension-washout-lag</property>

    <property value="0">systems/afcs/heading-hold-active</property>
    <property value="0">systems/afcs/SAS-roll-demand</property>

        <property value="1">fcs/yaw-damper-enable</property>
        <property value="0">fcs/pitch-damper-enable</property>
        <property value="0">fcs/roll-sas-enable</property>
        <property value="0">fcs/external-tanks-fitted</property>
        <property value="0">fcs/aim-fitted</property>

        <property>systems/NWS/engaged</property>

    <property>fcs/hook-engage</property>
    <property>fcs/flap-cmd-sum</property>
    <property>fcs/roll-trim-sas-cmd-norm</property>


<channel name="Auxiliary">
        <pure_gain name="Pilot G">
            <input>accelerations/n-pilot-z-norm</input>
            <gain>-1</gain>
            <output>/accelerations/pilot-gdamped</output>
        </pure_gain>

            <switch name="position/aircraft-on-ground">
                <description>Aircraft on ground</description>
                <default value="0"/>
                <test value="1" logic="OR">
                    gear/unit[0]/WOW ne 0
                    gear/unit[1]/WOW ne 0
                    gear/unit[2]/WOW ne 0
                </test>
            </switch>
            <fcs_function name="aero/alpha-indicated-deg">
                <description>ARI nose probe; ref ADA101648 p84; alpha_true = .8122 alphaNOSEPROBE + .797deg</description>
                <function>
                    <product>
                        <sum>
                            <property> aero/alpha-deg </property>
                            <value> -0.797 </value>
                        </sum>
                        <value>1.231223836</value>
                    </product>
                </function>
            </fcs_function>
            <fcs_function name="aero/aero-rp-x-in">
                <function>
                    <description>Centre of pressure due to mach</description>
                    <sum>
                        <table>
                            <independentVar lookup="row">velocities/mach</independentVar>
                            <tableData>
                                0.00    419
                                2.4     445
                            </tableData>
                        </table>
                    </sum>
                </function>
                <output>metrics/aero-rp-x-in</output>
            </fcs_function>

            <fcs_function name="aero/cadc-control-effectivity-factor">
                <function>
                    <description>High speeds CADC control effectivity limitation of rudder and elevator</description>
                    <sum>
                        <table>
                            <independentVar lookup="row">velocities/mach</independentVar>
                            <!-- mach 2.40 with wingsweep 22deg isn't in the envelope -->
                            <tableData>
                                0.00  1.0
                                0.20  1.0
                                0.25  0.7
                                0.40  0.6
                                1.00  0.2
                                2.40  0.1
                            </tableData>
                        </table>
                    </sum>
                </function>
            </fcs_function>

</channel>
        <channel name="extra-aero">

            <!-- need %Cg in chord for moments [Xcg - Xref)/100] -->
            <summer name="cg-x-offset-chord-in">
                <input> inertia/cg-x-in</input>
                <input> -metrics/aero-rp-x-in</input>
                <output>inertia/cg-x-offset-chord-in</output>
            </summer>

            <pure_gain name="cg-x-chord-percent">
                <description>Percent offset of the CoP from the CG</description>
                <input>inertia/cg-x-offset-chord-in</input>
                <gain> -0.01</gain>
                <clipto>
                    <min> -1 </min>
                    <max> 1 </max>
                </clipto>
                <output> inertia/cg-x-mac-percent </output>
            </pure_gain>

            <fcs_function name="pb">
                <description>PB Denormalization</description>
                <function>
                    <quotient>
                        <product>
                            <property>metrics/bw-ft</property>
                            <property>velocities/p-aero-rad_sec</property>
                        </product>
                        <!-- over -->
                        <product>
                            <value>2</value>
                            <property>velocities/vt-fps</property>
                        </product>
                    </quotient>
                </function>
                <clipto>
                    <min> -1.00 </min>
                    <max>  1.00 </max>
                </clipto>
                <output>aero/pb</output>
            </fcs_function>

            <fcs_function name="cbarq-2vo">
                <description>For denormalization</description>
                <function>
                    <quotient>
                        <product>
                            <property>metrics/cbarw-ft</property>
                            <property>velocities/q-aero-rad_sec</property>
                        </product>
                        <!-- over -->
                        <product>
                            <value>2</value>
                            <property>velocities/vt-fps</property>
                        </product>
                    </quotient>
                </function>
                <clipto>
                    <min> -2.01 </min>
                    <max>  2.01 </max>
                </clipto>
                <output>aero/qb</output>
            </fcs_function>
            <fcs_function name="rb-2vo">
                <description>For denormalization</description>
                <function>
                    <quotient>
                        <product>
                            <property>metrics/bw-ft</property>
                            <property>velocities/r-aero-rad_sec</property>
                        </product>
                        <!-- over -->
                        <product>
                            <value>2</value>
                            <property>velocities/vt-fps</property>
                        </product>
                    </quotient>
                </function>
                <clipto>
                    <min> -1.00 </min>
                    <max>  1.00 </max>
                </clipto>
                <output>aero/rb</output>
            </fcs_function>


            <fcs_function name="aero-cos-alpha">
                <function>
                    <product>
                        <cos>
                            <property>aero/alpha-rad</property>
                        </cos>
                    </product>
                </function>
                <output>aero/cos-alpha</output>
            </fcs_function>

            <fcs_function name="aero-sin-alpha">
                <function>
                    <product>
                        <sin>
                            <property>aero/alpha-rad</property>
                        </sin>
                    </product>
                </function>
                <output>aero/sin-alpha</output>
            </fcs_function>


        </channel>
        <channel name="SAS">
            <!-- yaw damper only active when in range alpha +/10 deg -->
            <switch name="fcs/yaw-damper-active">
                <default value="0.0"/>
                <test logic="AND" value="1">
                    aero/alpha-rad ge -0.175438596491228
                    aero/alpha-rad le  0.175438596491228
                    fcs/yaw-damper-enable ne 0.0
                </test>
                <output>fcs/yaw-damper-active</output>
            </switch>

            <switch name="fcs/roll-sas-active">
                <default value="0.0"/>
                <test logic="AND" value="1">
                    aero/alpha-rad ge -0.175438596491228
                    aero/alpha-rad le  0.2631578947368421
                    fcs/roll-sas-enable ne 0.0
                </test>
                <output>fcs/roll-sas-active</output>
            </switch>
            <scheduled_gain name="Yaw Damper Rate">
                <input>velocities/r-aero-rad_sec</input>
                <table>
                    <independentVar lookup="row">velocities/ve-kts</independentVar>
                    <tableData>
                        30     0.00
                        60     2.0
                    </tableData>
                </table>
                <gain>fcs/yaw-damper-active</gain>
            </scheduled_gain>

            <switch name="fcs/pitch-damper-active">
                <default value="0.0"/>
                <test logic="AND" value="1">
                    aero/alpha-rad ge -0.175438596491228
                    aero/alpha-rad le  0.2631578947368421
                    fcs/elevator-cmd-norm ge -0.15
                    fcs/elevator-cmd-norm le 0.15
                    fcs/pitch-damper-enable ne 0.0
                </test>
                <output>fcs/pitch-damper-active</output>
            </switch>

            <scheduled_gain name="Pitch Damper Rate">
                <!-- Figure 2-57 F14AAD-1  -->
                <input>velocities/q-aero-rad_sec</input>
                <table>
                    <independentVar lookup="row">velocities/ve-kts</independentVar>
                    <tableData>
                        30     0.00
                        60     1
                    </tableData>
                </table>
                <gain>fcs/pitch-damper-active</gain>
                <min> -0.2857142857142857 </min>
                <max>  0.2857142857142857 </max>
            </scheduled_gain>

            <scheduled_gain name="fcs/roll-rate-limiter">
                <input>fcs/aileron-cmd-norm</input>
                <table>
                    <independentVar lookup="row">velocities/p-aero-rad_sec</independentVar>
                    <tableData>
                        -6.2    -1.0
                        -1.4     0.0
                        1.4     0.0
                        6.2    -1.0
                    </tableData>
                </table>
                <gain>fcs/roll-sas-active</gain>
            </scheduled_gain>
</channel>

        <channel name="Nose Wheel Steering">
            <switch name="systems/NWS/engaged">
                <default value="0"/>
                <test value="1">
                    gear/unit[0]/wheel-speed-fps le 135
                    systems/hydraulics/combined-system-pressure ne 0
                    position/aircraft-on-ground ne 0
                    systems/holdback/launchbar-engaged eq 0
                </test>
                <output>systems/NWS/engaged</output>
            </switch>

            <scheduled_gain name="fcs/scheduled-steer-pos-deg">
                <input>fcs/steer-cmd-norm</input>
                <table>
                    <independentVar lookup="row">gear/unit[0]/wheel-speed-fps</independentVar>
                    <independentVar lookup="column">systems/NWS/engaged</independentVar>
                    <tableData>
                            0   1
                        0   0   87
                        80  0   15
                        135 0   0
                    </tableData>
                </table>
                <output>fcs/steer-pos-deg</output>
            </scheduled_gain>
        </channel>

        <channel name="SoundFX">
            <fcs_function name="fcs/flap-windfx-volume">
                <function>
                    <product>
                        <property>velocities/ve-kts</property>
                        <property>fcs/flap-pos-norm</property>
                    </product>
                </function>
                <output>fcs/flap-windfx-volume</output>
            </fcs_function>
            <fcs_function name="fcs/gear-windfx-volume">
                <function>
                    <product>
                        <property>velocities/ve-kts</property>
                        <property>fcs/gear-control</property>
                    </product>
                </function>
                <output>fcs/gear-windfx-volume</output>
            </fcs_function>
        </channel>

    <channel name="MANOUEVRE">

        <fcs_function name="systems/cadc/manuv-flap-fully-extended-max-mn">
            <function>
                <description>Manoeuver slat/flap ful extension max alt/mn</description>
                <!-- NAVAIR 01-F14AAD-1 Figures 2-51,2-52: p. 2-93  -->
                <sum>
                    <table>
                        <independentVar lookup="row">position/h-sl-ft</independentVar>
                        <tableData>
                            0	0.5105
                            5000	0.5610
                            10000	0.6206
                            15000	0.6788
                            20000	0.7491
                            23000	0.8011
                            28500	0.8516
                            35000	0.8595
                            40000	0.8643
                        </tableData>
                    </table>
                </sum>
            </function>
        </fcs_function>

        <fcs_function name="systems/cadc/manuv-flap-partially-extended-max-mn">
            <function>
                <description>Manoeuver flap partial extension max alt/mn</description>
                <!-- NAVAIR 01-F14AAD-1 Figures 2-51,2-52: p. 2-93  -->
                <sum>
                    <table>
                        <independentVar lookup="row">position/h-sl-ft</independentVar>
                        <tableData>
                            0	0.5806
                            5000	0.6296
                            10000	0.6984
                            15000	0.7703
                            20000	0.8299
                            23000	0.8591
                            28500	0.8654
                            35000	0.8702
                            40000	0.8765
                        </tableData>
                    </table>
                </sum>
            </function>
        </fcs_function>

        <fcs_function name="systems/cadc/manuv-flapslat-extension-aoa">
            <function>
                <description>Manoeuver flapslat extension schedule, NAVAIR 01-F14AAD-1 Figures 2-51,2-52: p. 2-93 </description>
                <sum>
                    <table>
                        <independentVar lookup="row">velocities/mach</independentVar>
                        <tableData>
                            0.0000	10.45
                            0.3952	10.45
                            0.3962	8.12
                            0.4521	7.91
                            0.4987	7.63
                            0.5576	7.15
                            0.6042	6.69
                            0.6537	6.08
                            0.7034	5.65
                            0.7593	5.44
                            0.8060	5.48
                            0.8558	5.49
                        </tableData>
                    </table>
                </sum>
            </function>
        </fcs_function>

        <fcs_function name="systems/cadc/manuv-flapslat-retraction-aoa">
            <function>
                <description>Manoeuver flapslat retraction schedule</description>
                <!-- NAVAIR 01-F14AAD-1 Figures 2-52: p. 2-93  -->
                <sum>
                    <table>
                        <independentVar lookup="row">velocities/mach</independentVar>
                        <tableData>
                            0.0000	7.62
                            0.38	7.62
                            0.3982	5.30
                            0.4541	5.12
                            0.5007	4.81
                            0.5534	4.27
                            0.6061	3.71
                            0.6557	3.13
                            0.7053	2.74
                            0.7550	2.47
                            0.8079	2.37
                            0.8672	2.73
                        </tableData>
                    </table>
                </sum>
            </function>
        </fcs_function>


        <fcs_function name="systems/cadc/manuv-flap-extension-calc">
            <function>
                <description>NAVAIR 01-F14AAD-1 S 2.21.2.4 p. 2-92 </description>
                <product>
                    <table>
                        <independentVar lookup="row">aero/alpha-deg</independentVar>
                        <independentVar lookup="column">velocities/mach</independentVar>
                        <tableData>
                                0.00000	0.50000	0.60000	0.70000	0.80000	0.90000	1.00000
                            0	0.00000	0.00000	0.00000	0.00000	0.00000	0.00000	0.00000
                            5	0.00000	0.00000	0.00000	0.00000	0.00000	0.00000	0.00000
                            6	0.07000	0.07000	0.07000	0.07000	0.07000	0.00000	0.00000
                            20	0.28571	0.28571	0.18571	0.18571	0.18571	0.00000	0.00000
                            35	0.28571	0.28571	0.18571	0.18571	0.18571	0.00000	0.00000
                            40	0.28571	0.28571	0.18571	0.18571	0.18571	0.00000	0.00000
                            45	0.28571	0.28571	0.18571	0.18571	0.18571	0.00000	0.00000
                            50	0.28571	0.28571	0.18571	0.18571	0.18571	0.00000	0.00000
                            55	0.28571	0.28571	0.18571	0.18571	0.18571	0.00000	0.00000
                        </tableData>
                    </table>
                </product>
            </function>
        </fcs_function>

        <fcs_function name="systems/cadc/manuv-slat-extension-calc">
            <function>
                <description>NAVAIR 01-F14AAD-1 S 2.21.2.4 p. 2-92 </description>
                <product>
                    <table>
                        <independentVar lookup="row">aero/alpha-deg</independentVar>
                        <independentVar lookup="column">velocities/mach</independentVar>
                        <tableData>
                                0.000000	0.45         0.500000	0.800000	0.900000	1.000000
                            0	0.000000	0.000000    0.000000	0.000000	0.000000	0.000000
                            8	0.000000   	0.000000    0.076471	0.076471	0.000000	0.000000
                            10	0.105294	0.105294    0.135294	0.135294	0.000000	0.000000
                            20	0.429412	0.429412    0.429412	0.429412	0.000000	0.000000
                            25	0.429412	0.429412    0.429412	0.429412	0.000000	0.000000
                            55	0.429412	0.429412    0.429412	0.429412	0.000000	0.000000
                        </tableData>
                    </table>
                </product>
            </function>
        </fcs_function>

        <!-- ensure within operating envelope -->

        <switch name="systems/cadc/manuv-active">
            <default value="0.0"/>
        </switch>

        <switch name="systems/cadc/manuv-flap-extension-cmd">
            <default value="0"/>
            <test value="systems/cadc/manuv-flap-extension-calc">
                systems/cadc/manuv-active ne 0
                systems/cadc/manuv-flap-extension-calc ge systems/cadc/manuv-flap-extension-cmd
            </test>
            <test value="systems/cadc/manuv-flap-extension-cmd">
                systems/cadc/manuv-active ne 0
            </test>

        </switch>

        <switch name="systems/cadc/manuv-slat-extension-cmd">
            <default value="0"/>
            <test value="systems/cadc/manuv-slat-extension-calc">
                systems/cadc/manuv-active ne 0
            </test>
            <test value="systems/cadc/manuv-slat-extension-manual">
                systems/cadc/manuv-active eq 0
            </test>
        </switch>


    </channel>

    <channel name="AFCS">
        <!-- ensure within operating envelope -->

        <switch name="systems/afcs/altitude-hold-trigger">
            <default value="0.0"/>
            <test value="1.0">
                <and>
                    propulsion/engine[0]/set-running == 0
                    propulsion/engine[1]/set-running == 0
                    systems/afcs/altitude-hold-active ne 0
                </and>
            </test>
        </switch>

        <summer name="systems/afcs/altitude-hold-divergence">
            <input> systems/afcs/target-altitude-ft </input>
            <input> -position/h-sl-ft </input>
        </summer>


        <switch name="systems/afcs/altitude-hold-alt-diff-delta">
            <default value="0.0"/>

            <test value="0">
                systems/afcs/altitude-hold-divergence lt 20
                systems/afcs/altitude-hold-divergence gt -20
            </test>

            <test value="-systems/afcs/altitude-hold-lag-constant">
                systems/afcs/altitude-hold-divergence gt 10
                systems/afcs/altitude-hold-divergence lt systems/afcs/altitude-hold-alt-diff-feet
            </test>

            <test value="systems/afcs/altitude-hold-lag-constant">
                systems/afcs/altitude-hold-divergence lt -10
                systems/afcs/altitude-hold-divergence gt systems/afcs/altitude-hold-alt-diff-feet
            </test>

            <test value="-systems/afcs/altitude-hold-lag-constant">
                systems/afcs/altitude-hold-divergence lt -4
                systems/afcs/altitude-hold-alt-diff-feet ge -2000
            </test>

            <test value="systems/afcs/altitude-hold-lag-constant">
                systems/afcs/altitude-hold-divergence gt 4
                systems/afcs/altitude-hold-alt-diff-feet le 2000
            </test>


        </switch>

        <summer name="systems/afcs/altitude-hold-alt-diff-feet1">
            <input>systems/afcs/altitude-hold-alt-diff-feet</input>
            <input>systems/afcs/altitude-hold-alt-diff-delta</input>
            <output>systems/afcs/altitude-hold-alt-diff-feet</output>
        </summer>

        <pure_gain name="systems/afcs/altitude-hold-vsi-dmd-fps">
            <input> systems/afcs/altitude-hold-alt-diff-feet </input>
            <gain>0.0166666666666667</gain>
            <!-- from fpm to fps -->
        </pure_gain>

        <summer name="systems/afcs/altitude-hold-vsi">
            <input> systems/afcs/altitude-hold-vsi-dmd-fps </input>
            <input> -velocities/h-dot-fps  </input>
        </summer>

        <switch name="systems/afcs/altitude-hold-dmd-vsi">
            <default value="0.0"/>
            <test value="systems/afcs/altitude-hold-vsi">
                systems/afcs/altitude-hold-active == 1
            </test>
        </switch>

        <pid name="systems/afcs/altitude-hold-divergence-pid">
            <input>systems/afcs/altitude-hold-dmd-vsi</input>
            <kp> systems/afcs/altitude-hold-pid-kp </kp>
            <ki> systems/afcs/altitude-hold-pid-ki </ki>
            <kd> systems/afcs/altitude-hold-pid-kd </kd>
            <trigger> systems/afcs/altitude-hold-trigger </trigger>
        </pid>

<!--
        <pure_gain name="systems/afcs/altitude-hold-divergence-pid-contents">
            <input> systems/afcs/altitude-hold-divergence-pid </input>
            <gain> 1.0 </gain>
            <output>systems/afcs/altitude-hold-divergence-pid-contents</output>
        </pure_gain>
-->
        <pure_gain name="systems/afcs/elevator-cmd-out">
            <input> systems/afcs/altitude-hold-divergence-pid </input>
            <gain> -systems/afcs/altitude-hold-elevator-gain </gain>
            <clipto>
                <min> -0.6</min>
                <max> 0.6</max>
            </clipto>
            <output>systems/afcs/elevator-cmd-delta</output>
        </pure_gain>

    </channel>
</system>